# 传输层

单工：单向传输，比如电视、广播。都是只能单向传输给你，你没法回复电视吧。
半双工：可以双向传输，但是在同一个时间点内，只能单向通信。比如对讲机。
全双工：可以在任意时间点同时双向传输，双向通信。比如电话

1. 位于应用层和网络层之间
2. 是面向连接的、可靠的进程到进程通信的协议
3. TCP将提供双全工服务，即数据可在同一时间双向传播
4. TCP将若干个字节称为一个分组，此分组称为一个报文段(Segment)，也就是说数据在TCP层称做报文段
5. 对可靠性要求高的上层协议，实现可靠性的保证，如果数据丢失、损坏的情况下如何保证可靠性。网络层只管传递数据，成功与否并不关心。

## 传输层的功能

传输层是只有主机才有的层次，中间的网路设备，最多只有三层，只能到网络层。
传输层是为应用层提供通信服务，同时它可以使用网络层的服务。
1. **传输层提供进程和进程之间的逻辑通信。**
我们知道在网络层是实现主机之间的通信(主机与主机之间的逻辑通信)，信息传输到主机即可。但是实际上这并没有通信完全，比如QQ之间进行对话，不能只是传递到对方主机，还需要传递到对方主机的QQ进程上，实现源主机的QQ进程和目标主机的QQ进程之间的通信才算一个完整的通信。

2. **复用和分用**
复用是指发送方不同的应用进程都可以使用同一个传输层传输数据。比如QQ和微信都可以使用同一个传输层协议来进行发送数据。<br/>
分用是指接收方的传输层在剥去报文的首部后能够把这些数据正确交付到目的应用进程。是指传输层接收到的是多个进程的数据，比如QQ和微信的，因此需要分别交付给QQ和微信来进行处理，也就是分开处理。

3. **传输层对收到的报文进行差错检测**
在网络层只对报文首部数据进行首部数据和校验，不会对传输数据进行校验，而传输层需要对数据进行检测，这样的话才能够实现对整个数据的校验，确保数据的不出错。
4. **传输层的两个协议：TCP和UDP**
纯属层有两个好兄弟，大哥TCP和二弟UDP，大哥靠谱，二弟不靠谱。
TCP:传送数据之前必须建立连接，数据传送结束之后要释放连接。不提供广播或者多播服务。由于TCP要提供可靠的面向连接的传输服务，因此不可避免地增加了许多开销：回复确认、流程控制、计时器以及连接管理等。**可靠，面向连接，时延大，适用于大文件**<br>
UDP:传送数据之前不需要建立连接，收到UDP报文后也不需要给出任何确认。**不可靠，无连接，时延小，适用于小文件**


### 传输层的寻址和端口
复用：应用层所有的应用进程都可以通过传输层再传输到网络层。
分用：传输层从网络层收到数据后交付指明的应用进程。
#### 端口

那么它是如何找到指明的应用进程。我们知道在网络层是通过IP找到对应的网络，再通过物理地址MAC地址找到对应的主机。
而在传输层也是一样的，通过**端口**来指明找到对应的应用进程。
端口是传输层的SAP，标识主机中的应用进程。每个端口通过一个数字即端口号来进行标识，端口号只有本地意义，在因特网中不同计算机的相同端口号是没有联系的。

端口号长度为16bit，能表示65536个不同的端口号。
![端口号分类](https://ftp.bmp.ovh/imgs/2021/02/01655e47cde73d61.jpg)

#### 套接字socket
在网络中采用发送方和接收方的套接字组合来识别端点，套接字唯一标识了网络中的一个主机和它上面的一个进程。
套接字Socket = (主机IP地址，端口号)


### UDP协议(用户数据报协议)
UPD协议只是在IP数据服务之上增加了很少的功能，即复用分用和差错检测功能。
UDP的主要特点：
1. UDP是无连接的，减少了连接、维持连接，断开连接的开销和发送数据之前的时延（无连接的）
2. UDP使用最大努力交付，即不保证可靠交付（不可靠的）
3. UDP是面向报文的，适合一次性传输少量的数据。所谓的面向报文就是应用层给UDP多长的报文，UDP就照样发送，不会做处理，即一次发送一个完整报文。因此，UDP发送的报文必须是大小合适的报文。否则传输的数据还需要在网络层进行分片，影响网络层的传输。
4. UDP没有拥塞控制，适合很多实时应用。

#### UDP首部格式(8个字节)
16位源端口号：2个字节，16位。源端口号可写可不写，如果想要获取到对方的回复，那么可以写上，否则不需要写。
16位目的端口号：2个字节，16位。必须要有。
16位UDP长度：2个字节，16位。用户数据包的整个长度。包括UDP首部和UDP数据。
16位的UDP检验和：2个字节，16位。检测整个UDP数据报（包括首部字段和数据字段）是否有错，有错就丢弃。
分用时如果找不到对应的目的端口号，就丢弃报文，并给发送方发送ICMP“端口不可达”差错报告报文。


### TCP协议

#### TCP特点
1. TCP是面向连接(虚连接)的传输层协议。也就是说应用之间要通信，必须先建立连接。类似于打电话一样，必须接通之后才能通话。
2. 每一条TCP连接只能有两个端点，每一条TCP连接只能是点对点的。因此，TCP协议没办法进行广播或者多播服务。
3. TCP提供可靠交付的服务，无差错、不丢失、不重复和按序到达。
4. TCP提供全双工通信。(发送缓存和接收缓存)
5. TCP是面向字节流的。流是进入到进程或者从进程流出的字节序列。TCP把应用程序交下来的数据看成是一连串的无结构的字节流。
![TCP字节流](https://ftp.bmp.ovh/imgs/2021/02/c834c4a4464ab147.jpg)
如上图所示：假如要发送一个这样的文件，那么TCP会将其按照字节进行编号，比如1，2，3...字节，发送时先将这些字节放入TCP缓存中等待发送，发送时先取其中几个字节组成一个报文段，然后加上TCP头进行发送。


#### TCP报文段首部格式
源端口和目的端口：建立连接所必须的端口号。

序号：本报文段发送数据的首个字节对应的序号，比如这次发送的数据是从3-10，那么序号就是3。

确认号：是期望收到对方的下一个报文段的数据的第一个字节的序号。若确认号为N，表示到序号N-1为止，所有的数据都已正确接收到。

6个控制位：
**紧急位URG(Urgent)**：URG=1时，表明此报文段中有紧急数据，是高优先级的数据，应尽快传送，不用在缓存里排队，配合紧急指针字段使用。（在发送方的紧急处理）
**确认位ACK(Acknowledgemnt)**:ACK=1时确认号有效，在连接建立后所有传送的报文段都必须把ACK置位1.
**推送位PSH(Push)**：PSH=1时，接收方尽快交付接收应用程序，不再等到缓存填满再向上交付。（在接收方的紧急处理）
**复位RET(RESET)**:RST=1时，表明TCP连接中出现了严重差错，必须释放连接，然后再重新建立传输连接。

**同步位SYN(Sync)**：SYN=1时，表明是一个连接请求/连接接收报文。
**终止位FIN(Final)**：FIN=1时，表明此报文发送数据已发完，要求释放连接。

窗口：指的是发送本报文段的一方的接收窗口，即现在允许对方发送的数据量。
检验和：检验首部和数据，检验时要加上12B的伪首部，第4个字段为协议字段，TCP的协议字段为6。

![TCP首部字段](https://ftp.bmp.ovh/imgs/2021/02/532f7f9ad864e926.jpg)